<aside class="widget widget-product-categories">
  <h3 class="widget-title">
    <%= t(:categories) %>
  </h3>
  <ul class="product-categories">

    <% @categories.each do |category| %>
        <li class="menu-item">
          <div class="category-row">
            <%= link_to categories_path(category.permalink), class: 'category-link' do %>
                <% if category.image.present? %>
                  <%= image_tag category.image.url, class: 'category-icon', alt: category.name %>
                <% else %>
                  <i class="fa fa-folder category-icon-fallback"></i>
                <% end %>
                <span class="category-name"><%= category.name %></span>
            <% end %>
            <% if category.sub_categories.present? %>
              <span data-ref="top-cat-taxm-<%= category.id %>" class='collapse-ref'> 
                <i class='fa fa-plus'></i> 
              </span>
            <% end %>
          </div>
          <%= render partial: 'products/shared/sub_category', locals: { subcategories: category.sub_categories, category: category, selected: @category } if category.sub_categories.present? %>
        </li>
    <% end %>
  </ul>
</aside>

<script type="text/javascript">
    $(function () {
        // Mark active categories as expanded
        $.each($('.product-categories > li'), function (index, element) {
            if ($(element).has('a.active').length > 0) {
                $(element).addClass('top-active').find('.collapse-ref i').toggleClass('fa-plus fa-minus');
            }
        });
        
        // Handle collapse/expand toggle
        $('.collapse-ref').click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            
            var ref = $(this).attr('data-ref');
            $(this).find('i').toggleClass('fa-plus fa-minus');
            $('#' + ref).slideToggle(300);
            
            return false;
        });
    });
</script>
